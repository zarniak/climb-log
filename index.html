<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClimbLog - Trener Wspinaczki (Online)</title>
    
    <!-- Style: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UNPKG) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #ffffff; color: #1f2937; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        /* Custom inputs for cleaner look */
        .clean-input {
            background: transparent;
            border-bottom: 1px solid #e5e7eb;
            outline: none;
            transition: border-color 0.2s;
        }
        .clean-input:focus {
            border-color: #3b82f6;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Error Handler -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            if (message.includes('ResizeObserver')) return;
            const errorContainer = document.createElement('div');
            errorContainer.innerHTML = `
                <div style="position: fixed; top: 20px; left: 20px; right: 20px; z-index: 9999; padding: 20px; font-family: sans-serif; color: #7f1d1d; background: #fef2f2; border: 2px solid #ef4444; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="margin-top:0; font-weight: bold;">⚠️ Błąd aplikacji</h3>
                    <p>Wystąpił problem techniczny.</p>
                    <div style="font-size: 12px; background: rgba(255,255,255,0.7); padding: 10px; border-radius: 4px; overflow: auto; max-height: 100px;">
                        ${message}
                    </div>
                </div>
            `;
            document.body.appendChild(errorContainer);
        };
    </script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            // ------------------------------------------------------------------
            // KONFIGURACJA UŻYTKOWNIKA (BEZPIECZEŃSTWO)
            // ------------------------------------------------------------------
            // 1. Wejdź na https://console.firebase.google.com/
            // 2. Skopiuj konfigurację ze swojego projektu (Project Settings -> General)
            // 3. Wklej poniżej zamiast pustych cudzysłowów
            // ------------------------------------------------------------------
            
            const userConfig = {
                apiKey: "AIzaSyAgIGDQaKWHcBiEUwVavMOpj5TX5n81Bnw",
                authDomain: "climblog-7432b.firebaseapp.com",
                projectId: "climblog-7432b",
                storageBucket: "climblog-7432b.firebasestorage.app",
                messagingSenderId: "155094312417",
                appId: "1:155094312417:web:19e35e3699737be22cdea0"
            }; 

            // Fallback dla środowiska Canvas (nie dotyczy Twojego hostingu)
            const firebaseConfig = (userConfig.apiKey !== "TU_WKLEJ_API_KEY") ? userConfig : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'climblog-production';

            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);
                window.appId = appId;
                window.firestoreOps = { collection, doc, setDoc, deleteDoc, onSnapshot, query, getDocs, writeBatch, signInAnonymously, signInWithCustomToken };
                console.log("Firebase initialized.");
            } else {
                console.warn("Brak konfiguracji Firebase. Uzupełnij obiekt userConfig w kodzie.");
            }
        } catch (e) {
            console.error("Firebase init failed:", e);
        }
    </script>

    <script type="text/babel">
        if (!window.React || !window.ReactDOM) throw new Error("Brak Reacta.");
        const { useState, useEffect, useRef, useCallback } = React;

        // --- IKONY SVG ---
        function IconBase({ children, size = 24, className = "" }) {
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
            );
        }

        const Calendar = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const CalendarPlus = (p) => <IconBase {...p}><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M10 16h4"/><path d="M12 14v4"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const MessageSquare = (p) => <IconBase {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2-2h14a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>;
        const Dumbbell = (p) => <IconBase {...p}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></IconBase>;
        const Trash = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></IconBase>;
        const ClipboardList = (p) => <IconBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;

        // --- KOMPONENTY UI ---
        function Card({ children, className = "" }) {
            return (
                <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden ${className}`}>{children}</div>
            );
        }

        function Badge({ children, type = 'neutral' }) {
            const colors = { neutral: 'bg-gray-100 text-gray-600', success: 'bg-green-50 text-green-700 border border-green-100', warning: 'bg-amber-50 text-amber-700 border border-amber-100' };
            return <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wide ${colors[type]}`}>{children}</span>;
        }

        function Header({ title, icon: Icon, action }) {
            return (
                <div className="flex justify-between items-center mb-6 pt-2">
                    <h2 className="text-xl font-bold text-gray-800 flex items-center">
                        <div className="p-2 bg-blue-50 text-blue-600 rounded-lg mr-3">
                            <Icon size={20} />
                        </div>
                        {title}
                    </h2>
                    {action}
                </div>
            );
        }

        // --- DANE DOMYŚLNE ---
        const INITIAL_EXERCISE_LIBRARY = [
            { id: 'ex_pull_australian', name: 'Podciąganie Australijskie', category: 'Siła', defaultSeries: 3, defaultReps: '5', defaultLoad: 'masy ciała', defaultDescription: 'Dynamiczny ruch w górę, powolne opuszczanie.' },
            { id: 'ex_plank', name: 'Plank Klasyczny', category: 'Core', defaultSeries: 5, defaultReps: '40s', defaultLoad: '-', defaultDescription: 'Trzymaj napięty brzuch, nie opuszczaj bioder.' },
            { id: 'ex_hangboard_90', name: 'Zwis 90 stopni', category: 'Siła Palców', defaultSeries: 3, defaultReps: '10s', defaultLoad: 'masy ciała', defaultDescription: 'Łokcie lekko zgięte, chwyt otwarty.' },
            { id: 'ex_climb_endurance', name: 'Obwody / Wytrzymałość', category: 'Wspinanie', defaultSeries: 1, defaultReps: '1', defaultLoad: '6a', defaultDescription: 'Wspinanie ciągłe, staraj się odpoczywać na chwytach.' },
        ];

        const generateCalendarLink = (training) => {
            const text = encodeURIComponent(`Trening Wspinaczkowy @ ${training.location}`);
            const details = encodeURIComponent(`Plan: ${training.coachNotes}`);
            const dates = `${training.date.replace(/-/g, '')}T180000/${training.date.replace(/-/g, '')}T200000`;
            return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&details=${details}&dates=${dates}`;
        };

        // --- WIDOKI ---

        function TrainingListView({ trainings, onSelect, onAdd, exerciseLibrary }) {
            const [viewMode, setViewMode] = useState('planned');
            const filtered = trainings.filter(t => !!t.isCompleted === (viewMode === 'completed'));
            const sorted = [...filtered].sort((a, b) => viewMode === 'planned' ? new Date(a.date) - new Date(b.date) : new Date(b.date) - new Date(a.date));

            return (
                <div className="p-4 pt-6 pb-24 animate-fade-in max-w-md mx-auto">
                    <Header 
                        title="Twoja Rozpiska" 
                        icon={Calendar} 
                        action={<button onClick={onAdd} className="bg-blue-600 text-white w-10 h-10 rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 transition active:scale-95 flex items-center justify-center"><Plus size={24} /></button>}
                    />
                    
                    <div className="bg-gray-100 p-1 rounded-xl flex mb-6">
                        <button onClick={() => setViewMode('planned')} className={`flex-1 py-1.5 text-xs font-bold uppercase tracking-wide rounded-lg transition ${viewMode === 'planned' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>Zaplanowane</button>
                        <button onClick={() => setViewMode('completed')} className={`flex-1 py-1.5 text-xs font-bold uppercase tracking-wide rounded-lg transition ${viewMode === 'completed' ? 'bg-white text-emerald-600 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>Zakończone</button>
                    </div>

                    {sorted.length === 0 ? (
                        <div className="text-center py-16 text-gray-300">
                            <ClipboardList className="mx-auto mb-3 opacity-20" size={48} />
                            <p className="text-sm font-medium">{viewMode === 'planned' ? 'Brak zaplanowanych treningów' : 'Brak historii'}</p>
                        </div>
                    ) : (
                        sorted.map((t) => (
                            <Card key={t.id} className="mb-3 hover:border-blue-100 transition duration-200 group">
                                <div className="p-4 cursor-pointer" onClick={() => onSelect(t.id)}>
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <div className="text-sm font-bold text-gray-800">
                                                {new Date(t.date).toLocaleDateString('pl-PL', { weekday: 'long', month: 'long', day: 'numeric' })}
                                            </div>
                                            <div className="flex items-center text-gray-400 mt-0.5">
                                                <MapPin size={12} className="mr-1" />
                                                <span className="text-xs">{t.location || 'Brak lokalizacji'}</span>
                                            </div>
                                        </div>
                                        {t.isCompleted ? <Badge type="success">Ukończony</Badge> : <Badge type="warning">Zaplanowany</Badge>}
                                    </div>
                                    <div className="mt-3 space-y-1 pl-1 border-l-2 border-gray-100 group-hover:border-blue-100 transition">
                                        {t.exercises && t.exercises.slice(0, 2).map((ex, idx) => (
                                            <div key={idx} className="text-xs text-gray-500 flex justify-between">
                                                <span>{exerciseLibrary.find(e => e.id === ex.exerciseId)?.name || 'Ćwiczenie'}</span>
                                                <span className="font-mono text-gray-400">{ex.series}x{ex.reps}</span>
                                            </div>
                                        ))}
                                        {t.exercises && t.exercises.length > 2 && <div className="text-[10px] text-gray-400 pt-1">+ {t.exercises.length - 2} więcej</div>}
                                    </div>
                                </div>
                            </Card>
                        ))
                    )}
                </div>
            );
        }

        function TrainingDetailView({ training, isEditing, onToggleEdit, onClose, onUpdateTraining, onUpdateExercise, onAddExercise, onDeleteExercise, onDeleteTraining, exerciseLibrary }) {
            if (!training) return null;
            const isCompleted = !!training.isCompleted;

            return (
                <div className="pb-24 animate-fade-in bg-white min-h-screen">
                    {/* Compact Top Bar */}
                    <div className="sticky top-0 bg-white/95 backdrop-blur-sm z-10 border-b border-gray-100 px-4 py-3 flex items-center justify-between">
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-800 flex items-center text-sm font-medium transition"><ChevronRight className="rotate-180 mr-1" size={18} /> Wróć</button>
                        <div className="flex items-center gap-2">
                            {isEditing && <button onClick={() => onDeleteTraining(training.id)} className="w-8 h-8 flex items-center justify-center text-red-400 hover:bg-red-50 rounded-full transition"><Trash size={16} /></button>}
                            <button onClick={onToggleEdit} className={`text-xs font-bold px-4 py-2 rounded-full transition uppercase tracking-wider ${isEditing ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{isEditing ? 'Gotowe' : 'Edytuj'}</button>
                        </div>
                    </div>

                    <div className="p-4 space-y-4 max-w-md mx-auto">
                        {/* Header Info */}
                        <div className="py-2">
                             {isEditing ? (
                                <input type="date" value={training.date} onChange={(e) => onUpdateTraining(training.id, 'date', e.target.value)} className="text-2xl font-bold text-gray-900 bg-transparent border-b border-gray-200 w-full outline-none" />
                            ) : (
                                <h1 className="text-2xl font-bold text-gray-900 capitalize">{new Date(training.date).toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long' })}</h1>
                            )}
                            
                            <div className="flex items-center mt-2 text-gray-500 text-sm">
                                <MapPin size={14} className="mr-1.5 text-blue-500" />
                                {isEditing ? <input value={training.location} onChange={(e) => onUpdateTraining(training.id, 'location', e.target.value)} className="clean-input w-full text-sm" placeholder="Gdzie się wspinasz?" /> : <span>{training.location || 'Dodaj lokalizację'}</span>}
                            </div>
                        </div>

                        {/* Status & Calendar */}
                        <div className="flex gap-3">
                             {isEditing ? (
                                <select 
                                    value={isCompleted ? 'true' : 'false'} 
                                    onChange={(e) => onUpdateTraining(training.id, 'isCompleted', e.target.value === 'true')} 
                                    className="flex-1 bg-gray-50 text-sm p-2 rounded-lg border border-gray-200 outline-none"
                                >
                                    <option value="false">Zaplanowany</option>
                                    <option value="true">Ukończony</option>
                                </select>
                            ) : (
                                <div className={`flex-1 px-3 py-2 rounded-lg text-xs font-bold uppercase tracking-wide flex items-center justify-center border ${isCompleted ? 'bg-green-50 text-green-700 border-green-100' : 'bg-amber-50 text-amber-700 border-amber-100'}`}>
                                    {isCompleted ? <><CheckCircle size={14} className="mr-1.5"/> Ukończony</> : 'Zaplanowany'}
                                </div>
                            )}
                            {!isEditing && (
                                <a href={generateCalendarLink(training)} target="_blank" className="w-10 flex items-center justify-center bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition border border-blue-100">
                                    <CalendarPlus size={18} />
                                </a>
                            )}
                        </div>

                        {/* Coach Notes */}
                        <div className="bg-yellow-50/50 border border-yellow-100 rounded-xl p-3">
                            <div className="flex items-start gap-2">
                                <MessageSquare size={16} className="text-yellow-600 mt-0.5 shrink-0" />
                                <div className="w-full">
                                    <span className="text-[10px] font-bold text-yellow-600 uppercase mb-1 block">Notatka Trenera</span>
                                    {isEditing ? <textarea value={training.coachNotes} placeholder="Wpisz cele..." onChange={(e) => onUpdateTraining(training.id, 'coachNotes', e.target.value)} className="w-full bg-white/50 border border-yellow-200/50 rounded p-2 text-sm outline-none" rows="2" /> : <p className="text-sm text-gray-700">{training.coachNotes || 'Brak uwag.'}</p>}
                                </div>
                            </div>
                        </div>

                        {/* Exercises List (Compact) */}
                        <div className="space-y-3 pt-2">
                            {training.exercises && training.exercises.map((ex, idx) => (
                                <div key={idx} className="bg-white border border-gray-100 rounded-xl p-3 relative shadow-sm hover:border-blue-200 transition">
                                    {isEditing && <button onClick={() => onDeleteExercise(training.id, idx)} className="absolute top-2 right-2 p-1.5 text-gray-300 hover:text-red-500 z-10"><Trash size={14} /></button>}
                                    
                                    <div className={isEditing ? 'pr-8 mb-2' : 'mb-1'}>
                                        {isEditing ? (
                                            <select value={ex.exerciseId} onChange={(e) => onUpdateExercise(training.id, idx, 'exerciseId', e.target.value)} className="w-full text-sm font-bold text-gray-800 bg-transparent border-b border-gray-200 outline-none pb-1">
                                                {exerciseLibrary.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                                            </select>
                                        ) : <h4 className="text-sm font-bold text-gray-800">{exerciseLibrary.find(l => l.id === ex.exerciseId)?.name || 'Ćwiczenie'}</h4>}
                                    </div>

                                    <div className="grid grid-cols-12 gap-3 items-start">
                                        <div className="col-span-7">
                                             {isEditing ? <textarea value={ex.description} onChange={(e) => onUpdateExercise(training.id, idx, 'description', e.target.value)} className="w-full bg-gray-50 border border-gray-200 rounded p-1.5 text-xs outline-none" rows="2" placeholder="Opis..." /> : <p className="text-xs text-gray-500 leading-relaxed">{ex.description}</p>}
                                        </div>
                                        <div className="col-span-5 space-y-1.5">
                                            <div className="flex justify-between text-xs border-b border-gray-50 pb-1">
                                                <span className="text-gray-400">Plan:</span>
                                                {isEditing ? (
                                                    <div className="flex gap-1">
                                                        <input value={ex.series} onChange={(e) => onUpdateExercise(training.id, idx, 'series', e.target.value)} className="w-6 text-center bg-gray-50 rounded" />
                                                        <span>x</span>
                                                        <input value={ex.reps} onChange={(e) => onUpdateExercise(training.id, idx, 'reps', e.target.value)} className="w-8 text-center bg-gray-50 rounded" />
                                                    </div>
                                                ) : <span className="font-mono font-medium text-gray-700">{ex.series}x{ex.reps}</span>}
                                            </div>
                                            <div className="flex justify-between text-xs border-b border-gray-50 pb-1">
                                                <span className="text-gray-400">Trud:</span>
                                                {isEditing ? <input value={ex.load} onChange={(e) => onUpdateExercise(training.id, idx, 'load', e.target.value)} className="w-16 text-right bg-gray-50 rounded" /> : <span className="font-mono text-gray-700">{ex.load}</span>}
                                            </div>
                                            <div className="pt-1">
                                                 {isEditing ? <input value={ex.actual} onChange={(e) => onUpdateExercise(training.id, idx, 'actual', e.target.value)} className="w-full text-xs p-1 border border-blue-200 rounded bg-blue-50 text-blue-800 outline-none" placeholder="Wynik..." /> : (ex.actual && <div className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded font-medium text-center">{ex.actual}</div>)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {isEditing && <button onClick={() => onAddExercise(training.id)} className="w-full py-3 border border-dashed border-blue-200 rounded-xl text-blue-500 text-sm font-semibold flex items-center justify-center hover:bg-blue-50 transition"><Plus size={18} className="mr-2" /> Dodaj ćwiczenie</button>}
                        </div>

                        {/* Feedback */}
                        <div className="pt-2">
                             <span className="text-[10px] font-bold text-gray-400 uppercase mb-2 block flex items-center"><MessageSquare size={12} className="mr-1"/> Twoje odczucia</span>
                            {isEditing ? <textarea value={training.feedback || ''} onChange={(e) => onUpdateTraining(training.id, 'feedback', e.target.value)} className="w-full p-3 rounded-xl border border-gray-200 outline-none text-sm min-h-[80px]" placeholder="Jak poszło?" /> : <div className="p-3 bg-gray-50 rounded-xl border border-gray-100 text-sm text-gray-600 italic">{training.feedback || 'Brak wpisu.'}</div>}
                        </div>
                    </div>
                </div>
            );
        }

        function AnalyticsView({ trainings, exerciseLibrary }) {
            const [statExId, setStatExId] = useState(exerciseLibrary[0]?.id || '');
            const stats = trainings.filter(t => t.exercises && t.exercises.some(e => e.exerciseId === statExId)).sort((a, b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="p-4 pt-6 pb-24 animate-fade-in max-w-md mx-auto">
                    <Header title="Twój Postęp" icon={TrendingUp} />
                    
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <label className="text-[10px] font-bold text-gray-400 uppercase mb-2 block">Wybierz Ćwiczenie</label>
                        <select value={statExId} onChange={(e) => setStatExId(e.target.value)} className="w-full p-2 bg-gray-50 rounded-lg border border-gray-200 outline-none text-sm font-medium text-gray-700">{exerciseLibrary.map(ex => <option key={ex.id} value={ex.id}>{ex.name}</option>)}</select>
                    </div>

                    <div className="space-y-3">
                    {stats.length === 0 ? <div className="text-center py-10 text-gray-300 text-sm">Brak danych dla tego ćwiczenia.</div> : stats.map(t => {
                        const ex = t.exercises.find(e => e.exerciseId === statExId);
                        return (
                            <div key={t.id} className="bg-white border-l-2 border-blue-500 pl-4 py-3 pr-3 rounded-r-xl shadow-sm flex justify-between items-center">
                                <div>
                                    <div className="text-xs font-bold text-gray-400 mb-0.5">{new Date(t.date).toLocaleDateString('pl-PL')}</div>
                                    <div className="text-sm font-bold text-gray-800">{ex.series} serii x {ex.reps}</div>
                                </div>
                                <div className="bg-gray-100 px-3 py-1 rounded text-xs font-mono font-medium text-gray-600">{ex.load}</div>
                            </div>
                        );
                    })}
                    </div>
                </div>
            );
        }

        function ExercisesView({ library, onUpdate, onAdd, onDelete, onFinishEditing }) {
            const [isEditing, setIsEditing] = useState(false);

            const handleToggleEdit = () => {
                if (isEditing) {
                    onFinishEditing(); // Przekierowanie po zakończeniu
                }
                setIsEditing(!isEditing);
            }

            return (
                <div className="p-4 pt-6 pb-24 animate-fade-in max-w-md mx-auto">
                    <Header 
                        title="Baza Ćwiczeń" 
                        icon={ClipboardList} 
                        action={<button onClick={handleToggleEdit} className={`text-xs font-bold px-4 py-2 rounded-full transition uppercase tracking-wide ${isEditing ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}`}>{isEditing ? 'Zakończ' : 'Edytuj'}</button>}
                    />
                    
                    <div className="space-y-3">
                        {library.map((ex, idx) => (
                            <Card key={ex.id} className="p-4 relative">
                                {isEditing && (
                                    <button onClick={() => onDelete(ex.id)} className="absolute top-3 right-3 p-1.5 text-gray-300 hover:text-red-500 transition z-10"><Trash size={16} /></button>
                                )}
                                <div className={isEditing ? 'pr-8 space-y-3' : 'space-y-1'}>
                                    {isEditing ? (
                                        <>
                                            <div>
                                                <label className="text-[9px] uppercase font-bold text-gray-400">Nazwa</label>
                                                <input value={ex.name} onChange={(e) => onUpdate(ex.id, 'name', e.target.value)} className="clean-input w-full text-sm font-bold pb-1" />
                                            </div>
                                            <div>
                                                <label className="text-[9px] uppercase font-bold text-gray-400">Kategoria</label>
                                                <input value={ex.category} onChange={(e) => onUpdate(ex.id, 'category', e.target.value)} className="clean-input w-full text-xs pb-1" />
                                            </div>
                                            <div>
                                                <label className="text-[9px] uppercase font-bold text-gray-400">Opis domyślny</label>
                                                <textarea value={ex.defaultDescription} onChange={(e) => onUpdate(ex.id, 'defaultDescription', e.target.value)} className="w-full text-xs border border-gray-200 rounded p-2 outline-none" rows="2" />
                                            </div>
                                            <div className="grid grid-cols-3 gap-2">
                                                <div><label className="text-[9px] uppercase font-bold text-gray-400">Serie</label><input type="number" value={ex.defaultSeries} onChange={(e) => onUpdate(ex.id, 'defaultSeries', parseInt(e.target.value))} className="w-full text-center text-xs bg-gray-50 border border-gray-200 rounded p-1.5" /></div>
                                                <div><label className="text-[9px] uppercase font-bold text-gray-400">Powt.</label><input value={ex.defaultReps} onChange={(e) => onUpdate(ex.id, 'defaultReps', e.target.value)} className="w-full text-center text-xs bg-gray-50 border border-gray-200 rounded p-1.5" /></div>
                                                <div><label className="text-[9px] uppercase font-bold text-gray-400">Trud.</label><input value={ex.defaultLoad} onChange={(e) => onUpdate(ex.id, 'defaultLoad', e.target.value)} className="w-full text-center text-xs bg-gray-50 border border-gray-200 rounded p-1.5" /></div>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="flex justify-between items-start">
                                                <h3 className="font-bold text-gray-800 text-sm">{ex.name}</h3>
                                                <span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">{ex.category}</span>
                                            </div>
                                            <p className="text-xs text-gray-500 leading-relaxed">{ex.defaultDescription || 'Brak opisu'}</p>
                                            <div className="text-[10px] text-gray-400 font-mono mt-1 pt-1 border-t border-gray-50">
                                                Domyślnie: {ex.defaultSeries}x{ex.defaultReps} | {ex.defaultLoad}
                                            </div>
                                        </>
                                    )}
                                </div>
                            </Card>
                        ))}

                        {isEditing && (
                            <button onClick={onAdd} className="w-full py-3 border border-dashed border-blue-200 rounded-xl text-blue-500 font-semibold text-sm flex items-center justify-center hover:bg-blue-50 transition">
                                <Plus size={18} className="mr-2" /> Dodaj Nowe Ćwiczenie
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        // --- GŁÓWNA APLIKACJA ---

        function App() {
            const [activeTab, setActiveTab] = useState('trainings');
            const [trainings, setTrainings] = useState([]);
            const [exerciseLibrary, setExerciseLibrary] = useState(INITIAL_EXERCISE_LIBRARY);
            const [selectedId, setSelectedId] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [user, setUser] = useState(null);
            const [isOnline, setIsOnline] = useState(false);
            const saveTimeout = useRef(null);

            // --- FIREBASE SYNC ---
            useEffect(() => {
                let unsubAuth = null;
                let unsubTrainings = null;
                let unsubSettings = null;

                const initSync = async () => {
                    let attempts = 0;
                    while (!window.firestoreOps && attempts < 20) { await new Promise(r => setTimeout(r, 100)); attempts++; }
                    if (!window.firestoreOps) return;

                    const { signInAnonymously, signInWithCustomToken, collection, doc, onSnapshot, query } = window.firestoreOps;
                    
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(window.auth, __initial_auth_token);
                        else await signInAnonymously(window.auth);
                    } catch (e) { console.error("Auth failed", e); return; }

                    unsubAuth = window.auth.onAuthStateChanged(async (u) => {
                        setUser(u);
                        setIsOnline(!!u);
                        if (u) {
                            const trainingsRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings');
                            unsubTrainings = onSnapshot(query(trainingsRef), (snap) => {
                                const data = snap.docs.map(d => d.data());
                                setTrainings(data.sort((a, b) => new Date(b.date) - new Date(a.date)));
                            });

                            const settingsRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'exercises');
                            unsubSettings = onSnapshot(settingsRef, (snap) => {
                                if (snap.exists()) {
                                    setExerciseLibrary(snap.data().list || INITIAL_EXERCISE_LIBRARY);
                                }
                            });
                        }
                    });
                };
                initSync();
                return () => { 
                    if (unsubAuth) unsubAuth(); 
                    if (unsubTrainings) unsubTrainings();
                    if (unsubSettings) unsubSettings();
                };
            }, []);

            // --- ZAPIS ---
            const saveTrainingToDb = useCallback((training) => {
                if (!user || !window.firestoreOps) return;
                if (saveTimeout.current) clearTimeout(saveTimeout.current);
                saveTimeout.current = setTimeout(async () => {
                    try {
                        const ref = window.firestoreOps.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings', training.id.toString());
                        await window.firestoreOps.setDoc(ref, training);
                    } catch (e) { console.error("Save error:", e); }
                }, 500);
            }, [user]);

            const saveLibraryToDb = useCallback((newLib) => {
                if (!user || !window.firestoreOps) return;
                try {
                    const ref = window.firestoreOps.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'exercises');
                    window.firestoreOps.setDoc(ref, { list: newLib });
                } catch (e) { console.error("Save lib error:", e); }
            }, [user]);

            // --- LOGIKA ---
            const handleUpdateT = (id, field, value) => {
                setTrainings(prev => {
                    const next = prev.map(t => t.id === id ? { ...t, [field]: value } : t);
                    const updated = next.find(t => t.id === id);
                    if (updated) saveTrainingToDb(updated);
                    return next;
                });
            };

            const handleUpdateE = (id, idx, field, value) => {
                setTrainings(prev => {
                    const next = prev.map(t => {
                        if (t.id !== id) return t;
                        const newEx = [...t.exercises];
                        newEx[idx] = { ...newEx[idx], [field]: value };
                        return { ...t, exercises: newEx };
                    });
                    const updated = next.find(t => t.id === id);
                    if (updated) saveTrainingToDb(updated);
                    return next;
                });
            };

            const handleAddE = (id) => {
                setTrainings(prev => {
                    const next = prev.map(t => {
                        if (t.id !== id) return t;
                        const currentExercises = Array.isArray(t.exercises) ? t.exercises : [];
                        const defaultEx = exerciseLibrary[0] || {};
                        return { 
                            ...t, 
                            exercises: [
                                ...currentExercises, 
                                { 
                                    exerciseId: defaultEx.id || 'unknown', 
                                    description: defaultEx.defaultDescription || '', 
                                    series: defaultEx.defaultSeries || 3, 
                                    reps: defaultEx.defaultReps || '10', 
                                    load: defaultEx.defaultLoad || '-', 
                                    actual: '' 
                                }
                            ] 
                        };
                    });
                    const updated = next.find(t => t.id === id);
                    if (updated) saveTrainingToDb(updated);
                    return next;
                });
            };

            const handleDeleteE = (id, idx) => {
                if(!confirm("Usuń ćwiczenie?")) return;
                setTrainings(prev => {
                    const next = prev.map(t => {
                        if (t.id !== id) return t;
                        return { ...t, exercises: t.exercises.filter((_, i) => i !== idx) };
                    });
                    const updated = next.find(t => t.id === id);
                    if (updated) saveTrainingToDb(updated);
                    return next;
                });
            };

            const handleDeleteT = async (id) => {
                if (!confirm("Usuń cały trening?")) return;
                if (user && window.firestoreOps) {
                    try {
                        await window.firestoreOps.deleteDoc(window.firestoreOps.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings', id.toString()));
                        setSelectedId(null); setIsEditing(false);
                    } catch (e) { console.error(e); }
                }
            };

            const handleAddT = async () => {
                const newId = Date.now();
                const defaultEx = exerciseLibrary[0] || {};
                const newT = { 
                    id: newId, 
                    date: new Date().toISOString().split('T')[0], 
                    location: '', 
                    // weight usunięte
                    isCompleted: false, 
                    feedback: '', 
                    coachNotes: '', 
                    exercises: [{ 
                        exerciseId: defaultEx.id || 'unknown', 
                        description: defaultEx.defaultDescription || '', 
                        series: defaultEx.defaultSeries || 3, 
                        reps: defaultEx.defaultReps || '10', 
                        load: defaultEx.defaultLoad || '-', 
                        actual: '' 
                    }] 
                };
                
                if (user && window.firestoreOps) {
                    const ref = window.firestoreOps.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings', newId.toString());
                    await window.firestoreOps.setDoc(ref, newT);
                }
                
                setTrainings(p => [newT, ...p]);
                setSelectedId(newId);
                setIsEditing(true);
            };

            const handleUpdateLib = (id, field, value) => {
                const newLib = exerciseLibrary.map(ex => ex.id === id ? { ...ex, [field]: value } : ex);
                setExerciseLibrary(newLib);
                saveLibraryToDb(newLib);
            };

            const handleAddLib = () => {
                const newEx = {
                    id: `ex_${Date.now()}`,
                    name: 'Nowe Ćwiczenie',
                    category: 'Ogólne',
                    defaultSeries: 3,
                    defaultReps: '10',
                    defaultLoad: '-',
                    defaultDescription: ''
                };
                const newLib = [...exerciseLibrary, newEx];
                setExerciseLibrary(newLib);
                saveLibraryToDb(newLib);
            };

            const handleDeleteLib = (id) => {
                if(!confirm("Czy na pewno chcesz usunąć to ćwiczenie z bazy?")) return;
                const newLib = exerciseLibrary.filter(ex => ex.id !== id);
                setExerciseLibrary(newLib);
                saveLibraryToDb(newLib);
            };

            const selected = trainings.find(t => t.id === selectedId);

            return (
                <div className="max-w-md mx-auto min-h-screen relative overflow-x-hidden">
                    {/* Status Bar (Thin Line) */}
                    <div className={`fixed top-0 left-0 w-full h-1 z-[100] transition-colors duration-500 ${isOnline ? 'bg-emerald-400' : 'bg-red-400'}`}></div>

                    {selected ? (
                        <TrainingDetailView 
                            training={selected} isEditing={isEditing} 
                            onToggleEdit={() => {
                                if (isEditing) saveTrainingToDb(selected); 
                                setIsEditing(!isEditing);
                            }} 
                            onClose={() => { setSelectedId(null); setIsEditing(false); }}
                            onUpdateTraining={handleUpdateT} onUpdateExercise={handleUpdateE}
                            onAddExercise={handleAddE} onDeleteExercise={handleDeleteE} onDeleteTraining={handleDeleteT}
                            exerciseLibrary={exerciseLibrary}
                        />
                    ) : activeTab === 'trainings' ? (
                        <TrainingListView trainings={trainings} onSelect={(id) => { setSelectedId(id); setIsEditing(false); }} onAdd={handleAddT} exerciseLibrary={exerciseLibrary} />
                    ) : activeTab === 'analytics' ? (
                        <AnalyticsView trainings={trainings} exerciseLibrary={exerciseLibrary} />
                    ) : (
                        <ExercisesView 
                            library={exerciseLibrary} 
                            onUpdate={handleUpdateLib} 
                            onAdd={handleAddLib} 
                            onDelete={handleDeleteLib} 
                            onFinishEditing={() => setActiveTab('trainings')}
                        />
                    )}
                    
                    {!selected && (
                        <div className="fixed bottom-0 max-w-md w-full bg-white/95 backdrop-blur-md border-t border-gray-100 flex justify-around py-3 z-50 shadow-[0_-5px_20px_rgba(0,0,0,0.02)]">
                            <button onClick={() => setActiveTab('trainings')} className={`flex flex-col items-center p-2 rounded-xl w-24 transition ${activeTab === 'trainings' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}><Calendar size={20} className="mb-1" /><span className="text-[9px] font-bold uppercase tracking-wider">Rozpiska</span></button>
                            <button onClick={() => setActiveTab('analytics')} className={`flex flex-col items-center p-2 rounded-xl w-24 transition ${activeTab === 'analytics' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}><TrendingUp size={20} className="mb-1" /><span className="text-[9px] font-bold uppercase tracking-wider">Postęp</span></button>
                            <button onClick={() => setActiveTab('exercises')} className={`flex flex-col items-center p-2 rounded-xl w-24 transition ${activeTab === 'exercises' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}><ClipboardList size={20} className="mb-1" /><span className="text-[9px] font-bold uppercase tracking-wider">Zadania</span></button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
