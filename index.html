<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClimbLog - Trener Wspinaczki</title>
    
    <!-- Style: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UNPKG) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Error Handler -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            if (message.includes('ResizeObserver')) return;
            const errorContainer = document.createElement('div');
            errorContainer.innerHTML = `
                <div style="position: fixed; top: 20px; left: 20px; right: 20px; z-index: 9999; padding: 20px; font-family: sans-serif; color: #7f1d1d; background: #fef2f2; border: 2px solid #ef4444; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="margin-top:0; font-weight: bold;">‚ö†Ô∏è B≈ÇƒÖd aplikacji</h3>
                    <p>WystƒÖpi≈Ç problem techniczny.</p>
                    <div style="font-size: 12px; background: rgba(255,255,255,0.7); padding: 10px; border-radius: 4px; overflow: auto; max-height: 100px;">
                        ${message}
                    </div>
                </div>
            `;
            document.body.appendChild(errorContainer);
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);
                window.appId = appId;
                window.firestoreOps = { collection, doc, setDoc, deleteDoc, onSnapshot, query, getDocs, writeBatch, signInAnonymously, signInWithCustomToken };
                console.log("Firebase initialized.");
            } else {
                window.isOffline = true;
            }
        } catch (e) {
            window.isOffline = true;
        }
    </script>

    <script type="text/babel">
        if (!window.React || !window.ReactDOM) throw new Error("Brak Reacta.");
        const { useState, useEffect, useRef } = React;

        // --- IKONY SVG ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Calendar = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const CalendarPlus = (p) => <IconBase {...p}><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M10 16h4"/><path d="M12 14v4"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const MessageSquare = (p) => <IconBase {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const Dumbbell = (p) => <IconBase {...p}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></IconBase>;
        const Trash = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></IconBase>;
        const ClipboardList = (p) => <IconBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>;

        const EXERCISE_LIBRARY = [
            { id: 'ex_pull_australian', name: 'PodciƒÖganie Australijskie', category: 'Si≈Ça' },
            { id: 'ex_plank', name: 'Plank Klasyczny', category: 'Core' },
            { id: 'ex_hangboard_90', name: 'Zwis 90 stopni', category: 'Si≈Ça Palc√≥w' },
            { id: 'ex_leg_raise', name: 'Wymachy n√≥g w przybloku', category: 'Core' },
            { id: 'ex_climb_endurance', name: 'Obwody / Wytrzyma≈Ço≈õƒá', category: 'Wspinanie' },
            { id: 'ex_bench_press', name: 'Wyciskanie na klatƒô', category: 'Si≈Ça' },
        ];

        // --- WIDOKI ---

        const TrainingListView = ({ trainings, onSelect, onAdd }) => {
            const [viewMode, setViewMode] = useState('planned');
            // Zmieniono logikƒô: patrzymy tylko na t.isCompleted
            const filtered = trainings.filter(t => !!t.isCompleted === (viewMode === 'completed'));
            const sorted = [...filtered].sort((a, b) => viewMode === 'planned' ? new Date(a.date) - new Date(b.date) : new Date(b.date) - new Date(a.date));

            return (
                <div className="p-4 pt-6 space-y-4 pb-20 animate-fade-in">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-slate-800 flex items-center"><Calendar className="mr-2 text-blue-600" /> Twoja Rozpiska</h2>
                        <button onClick={onAdd} className="bg-blue-600 text-white p-2 rounded-full shadow-lg hover:bg-blue-700 transition active:scale-95 flex items-center justify-center"><Plus size={24} /></button>
                    </div>
                    <div className="bg-slate-100 p-1 rounded-xl flex mb-6">
                        <button onClick={() => setViewMode('planned')} className={`flex-1 py-2 text-sm font-semibold rounded-lg transition ${viewMode === 'planned' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Zaplanowane</button>
                        <button onClick={() => setViewMode('completed')} className={`flex-1 py-2 text-sm font-semibold rounded-lg transition ${viewMode === 'completed' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500'}`}>Zako≈Ñczone</button>
                    </div>
                    {sorted.length === 0 ? (
                        <div className="text-center py-12 text-slate-400"><ClipboardList className="mx-auto mb-3 opacity-20" size={48} />{viewMode === 'planned' ? 'Brak zaplanowanych trening√≥w üéâ' : 'Brak historii trening√≥w'}</div>
                    ) : (
                        sorted.map((t) => (
                            <Card key={t.id} className="mb-4 hover:shadow-md transition duration-300">
                                <div className="p-4 cursor-pointer" onClick={() => onSelect(t.id)}>
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <div className={`text-sm font-semibold uppercase ${t.isCompleted ? 'text-emerald-600' : 'text-blue-600'}`}>{new Date(t.date).toLocaleDateString('pl-PL', { weekday: 'long', month: 'long', day: 'numeric' })}</div>
                                            <div className="flex items-center text-slate-600 mt-1"><MapPin size={14} className="mr-1" /><span className="text-sm">{t.location || 'Brak lokalizacji'}</span></div>
                                        </div>
                                        {t.isCompleted ? <Badge type="success">Uko≈Ñczony</Badge> : <Badge type="warning">Zaplanowany</Badge>}
                                    </div>
                                    <div className="mt-3 space-y-1">
                                        {t.exercises.slice(0, 2).map((ex, idx) => (
                                            <div key={idx} className="text-sm text-slate-500 flex justify-between">
                                                <span>‚Ä¢ {EXERCISE_LIBRARY.find(e => e.id === ex.exerciseId)?.name}</span>
                                                <span className="text-xs font-mono text-slate-400">{ex.series}x{ex.reps}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </Card>
                        ))
                    )}
                </div>
            );
        };

        const TrainingDetailView = ({ training, isEditing, onToggleEdit, onClose, onUpdateTraining, onUpdateExercise, onAddExercise, onDeleteExercise, onDeleteTraining }) => {
            if (!training) return null;
            // Wy≈ÇƒÖcznie pole boolean decyduje o statusie
            const isCompleted = !!training.isCompleted;

            return (
                <div className="pb-24 animate-fade-in">
                    <div className="sticky top-0 bg-white/95 backdrop-blur-md z-10 border-b border-slate-100 p-4 flex items-center justify-between shadow-sm">
                        <button onClick={onClose} className="text-slate-500 hover:text-slate-800 flex items-center"><ChevronRight className="rotate-180 mr-1" size={20} /> Wr√≥ƒá</button>
                        <h2 className="font-bold text-slate-800">Szczeg√≥≈Çy</h2>
                        <div className="flex items-center gap-2">
                            {isEditing && <button onClick={() => onDeleteTraining(training.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-full transition"><Trash size={20} /></button>}
                            <button onClick={onToggleEdit} className={`text-sm font-medium px-4 py-1.5 rounded-full transition ${isEditing ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600'}`}>{isEditing ? 'Gotowe' : 'Edytuj'}</button>
                        </div>
                    </div>
                    <div className="p-4 space-y-6">
                        <Card className={`p-5 text-white shadow-lg ${isCompleted ? 'bg-gradient-to-br from-emerald-700 to-teal-900' : 'bg-gradient-to-br from-slate-800 to-slate-900'}`}>
                            <div className="flex justify-between items-start">
                                <div className="w-full">
                                    {isEditing ? (
                                        <input type="date" value={training.date} onChange={(e) => onUpdateTraining(training.id, 'date', e.target.value)} className="bg-white/20 border-white/30 rounded px-2 py-1 text-white text-lg font-bold outline-none w-full" />
                                    ) : (
                                        <>
                                            <h1 className="text-2xl font-bold capitalize">{new Date(training.date).toLocaleDateString('pl-PL', { weekday: 'long' })}</h1>
                                            <p className="text-slate-200 text-sm">{new Date(training.date).toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                                        </>
                                    )}
                                    <div className="flex items-center mt-2 text-sm text-slate-200">
                                        <MapPin size={14} className="mr-1" />
                                        {isEditing ? <input value={training.location} onChange={(e) => onUpdateTraining(training.id, 'location', e.target.value)} className="bg-white/10 border-none rounded p-1 text-white text-sm w-full outline-none" placeholder="Lokalizacja..." /> : <span>{training.location || 'Brak lokalizacji'}</span>}
                                    </div>
                                </div>
                            </div>
                            <div className="mt-6 pt-4 border-t border-white/10 flex gap-4 text-sm">
                                <div className="flex-1">
                                    <label className="text-slate-300 block mb-1">Waga (kg)</label>
                                    {isEditing ? <input type="number" step="0.1" value={training.weight || ''} onChange={(e) => onUpdateTraining(training.id, 'weight', e.target.value)} className="w-full bg-black/20 text-white rounded px-2 py-1 border border-white/10 outline-none" /> : <div>{training.weight || '--'} kg</div>}
                                </div>
                                <div className="flex-1">
                                    <label className="text-slate-300 block mb-1">Status</label>
                                    {isEditing ? (
                                        <select value={isCompleted ? 'true' : 'false'} onChange={(e) => onUpdateTraining(training.id, 'isCompleted', e.target.value === 'true')} className="w-full bg-black/20 text-white rounded px-2 py-1 border border-white/10 outline-none">
                                            <option value="false" className="text-slate-100">Zaplanowany</option>
                                            <option value="true" className="text-slate-100">Uko≈Ñczony</option>
                                        </select>
                                    ) : <div className="flex items-center">{isCompleted ? 'Uko≈Ñczony' : 'Do zrobienia'}</div>}
                                </div>
                            </div>
                        </Card>
                        <div className={`bg-amber-50 border border-amber-100 rounded-lg p-4 text-sm flex gap-3 ${isEditing ? 'ring-2 ring-amber-200' : ''}`}>
                            <div className="shrink-0 text-amber-600"><User size={20} /></div>
                            <div className="w-full">
                                <span className="font-bold block text-amber-800 mb-1">Notatka Trenera:</span>
                                {isEditing ? <textarea value={training.coachNotes} placeholder="Wpisz cele..." onChange={(e) => onUpdateTraining(training.id, 'coachNotes', e.target.value)} className="w-full bg-white/50 border border-amber-200 rounded p-2 outline-none" rows="2" /> : training.coachNotes || 'Brak notatek'}
                            </div>
                        </div>
                        <div className="space-y-4">
                            <h3 className="font-bold text-slate-800 text-lg flex items-center"><Dumbbell className="mr-2 text-slate-400" size={20} /> Plan Treningowy</h3>
                            {training.exercises.map((ex, idx) => (
                                <Card key={idx} className="p-4 relative">
                                    {isEditing && <button onClick={() => onDeleteExercise(training.id, idx)} className="absolute top-2 right-2 p-1.5 text-slate-400 hover:text-red-500 z-20"><Trash size={16} /></button>}
                                    {/* Dodano pr-10 aby ikona ≈õmietnika nie nachodzi≈Ça na tekst */}
                                    <div className={`mb-2 ${isEditing ? 'pr-10' : ''}`}>
                                        {isEditing ? (
                                            <select value={ex.exerciseId} onChange={(e) => onUpdateExercise(training.id, idx, 'exerciseId', e.target.value)} className="w-full font-bold text-slate-700 bg-transparent border-b border-slate-300 outline-none pb-1">
                                                {EXERCISE_LIBRARY.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                                            </select>
                                        ) : <h4 className="font-bold text-slate-700">{EXERCISE_LIBRARY.find(l => l.id === ex.exerciseId)?.name}</h4>}
                                    </div>
                                    <div className="mb-3">
                                        {isEditing ? <textarea value={ex.description} onChange={(e) => onUpdateExercise(training.id, idx, 'description', e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm outline-none placeholder:text-slate-400" placeholder="Opis ƒáwiczenia..." /> : <div className="text-sm text-slate-600 italic bg-slate-50 p-2 rounded">{ex.description || 'Brak opisu'}</div>}
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 mb-3 text-center">
                                        {['series', 'reps', 'load'].map(f => (
                                            <div key={f}>
                                                <span className="text-[9px] font-bold text-slate-400 uppercase">{f === 'load' ? 'Trudno≈õƒá' : f === 'series' ? 'Serie' : 'Powt.'}</span>
                                                {isEditing ? <input type="text" value={ex[f]} onChange={(e) => onUpdateExercise(training.id, idx, f, e.target.value)} className="w-full text-center bg-slate-50 border border-slate-200 rounded p-1 text-sm outline-none" /> : <div className="font-mono font-bold text-slate-700">{ex[f]}</div>}
                                            </div>
                                        ))}
                                    </div>
                                    <div>
                                        <span className="text-[10px] font-bold text-blue-500 uppercase">Tw√≥j Wynik</span>
                                        {isEditing ? <input value={ex.actual} onChange={(e) => onUpdateExercise(training.id, idx, 'actual', e.target.value)} className="w-full text-sm p-2 border border-blue-200 rounded bg-blue-50 outline-none" placeholder="Co uda≈Ço siƒô zrobiƒá?" /> : <div className={`text-sm border-l-2 pl-2 ${ex.actual ? 'border-emerald-500' : 'border-slate-200 italic text-slate-400'}`}>{ex.actual || 'Brak wpisu'}</div>}
                                    </div>
                                </Card>
                            ))}
                            {isEditing && <button onClick={() => onAddExercise(training.id)} className="w-full py-3 border-2 border-dashed border-blue-200 rounded-xl text-blue-500 font-semibold flex items-center justify-center hover:bg-blue-50 transition"><Plus size={20} className="mr-2" /> Dodaj ƒáwiczenie</button>}
                        </div>
                    </div>
                </div>
            );
        };

        const AnalyticsView = ({ trainings }) => {
            const [statExId, setStatExId] = useState(EXERCISE_LIBRARY[1].id);
            const stats = trainings.filter(t => t.exercises.some(e => e.exerciseId === statExId)).sort((a, b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="p-4 pb-20 space-y-6 animate-fade-in">
                    <h2 className="text-xl font-bold text-slate-800 flex items-center"><TrendingUp className="mr-2 text-blue-600" /> Postƒôp</h2>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">ƒÜwiczenie</label>
                        <select value={statExId} onChange={(e) => setStatExId(e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-200 outline-none text-sm font-medium">{EXERCISE_LIBRARY.map(ex => <option key={ex.id} value={ex.id}>{ex.name}</option>)}</select>
                    </div>
                    {stats.length === 0 ? <div className="text-center py-10 text-slate-400">Brak danych.</div> : stats.map(t => {
                        const ex = t.exercises.find(e => e.exerciseId === statExId);
                        return (
                            <Card key={t.id} className="p-3 border-l-4 border-l-blue-500">
                                <div className="flex justify-between text-xs font-bold text-slate-500 mb-2"><span>{new Date(t.date).toLocaleDateString('pl-PL')}</span>{t.isCompleted ? <span className="text-emerald-600">Zrealizowane</span> : <span className="text-amber-600">Plan</span>}</div>
                                <div className="flex items-baseline gap-2">
                                    <div className="text-lg font-bold text-slate-800">{ex.series} x {ex.reps}</div>
                                    <div className="ml-auto bg-slate-100 px-2 py-1 rounded text-sm font-mono">{ex.load}</div>
                                </div>
                            </Card>
                        );
                    })}
                </div>
            );
        };

        function App() {
            const [activeTab, setActiveTab] = useState('trainings');
            const [trainings, setTrainings] = useState([]);
            const [selectedId, setSelectedId] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const saveTimeout = useRef(null);

            useEffect(() => {
                let unsubS = null; let unsubA = null;
                const init = async () => {
                    let attempts = 0;
                    while (!window.firestoreOps && attempts < 20) { await new Promise(r => setTimeout(r, 100)); attempts++; }
                    if (!window.firestoreOps) { setLoading(false); return; }
                    const { signInAnonymously, signInWithCustomToken, collection, query, onSnapshot, doc, setDoc } = window.firestoreOps;
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(window.auth, __initial_auth_token);
                        else await signInAnonymously(window.auth);
                    } catch (e) { setLoading(false); return; }
                    unsubA = window.auth.onAuthStateChanged(async (u) => {
                        setUser(u);
                        if (u) {
                            const ref = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings');
                            unsubS = onSnapshot(query(ref), (snap) => {
                                setTrainings(snap.docs.map(d => d.data()));
                                setLoading(false);
                            }, () => setLoading(false));
                        } else setLoading(false);
                    });
                };
                init();
                return () => { if (unsubS) unsubS(); if (unsubA) unsubA(); };
            }, []);

            const saveToDb = (training) => {
                if (!user || !window.firestoreOps) return;
                if (saveTimeout.current) clearTimeout(saveTimeout.current);
                saveTimeout.current = setTimeout(async () => {
                    try {
                        const ref = window.firestoreOps.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings', training.id.toString());
                        await window.firestoreOps.setDoc(ref, training);
                        console.log("Saved:", training.id);
                    } catch (e) { console.error("Save error:", e); }
                }, 400); // Skr√≥cono czas debouncingu
            };

            const handleUpdateT = (id, field, value) => {
                setTrainings(prev => {
                    const next = prev.map(t => t.id === id ? { ...t, [field]: value } : t);
                    const updated = next.find(t => t.id === id);
                    if (updated) saveToDb(updated);
                    return next;
                });
            };

            const handleUpdateE = (id, idx, field, value) => {
                setTrainings(prev => {
                    const next = prev.map(t => {
                        if (t.id !== id) return t;
                        const newEx = [...t.exercises];
                        newEx[idx] = { ...newEx[idx], [field]: value };
                        return { ...t, exercises: newEx };
                    });
                    const updated = next.find(t => t.id === id);
                    if (updated) saveToDb(updated);
                    return next;
                });
            };

            const handleAddE = (id) => {
                setTrainings(prev => {
                    const next = prev.map(t => t.id === id ? { ...t, exercises: [...t.exercises, { exerciseId: EXERCISE_LIBRARY[0].id, description: '', series: 3, reps: '10', load: '-', actual: '' }] } : t);
                    saveToDb(next.find(t => t.id === id));
                    return next;
                });
            };

            const handleDeleteE = (id, idx) => {
                if(!confirm("Usu≈Ñ ƒáwiczenie?")) return;
                setTrainings(prev => {
                    const next = prev.map(t => t.id === id ? { ...t, exercises: t.exercises.filter((_, i) => i !== idx) } : t);
                    saveToDb(next.find(t => t.id === id));
                    return next;
                });
            };

            const handleDeleteT = async (id) => {
                if (!confirm("Usu≈Ñ ca≈Çy trening?")) return;
                if (user && window.firestoreOps) {
                    try {
                        await window.firestoreOps.deleteDoc(window.firestoreOps.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings', id.toString()));
                        setSelectedId(null); setIsEditing(false);
                    } catch (e) { console.error(e); }
                }
            };

            const handleAddT = async () => {
                const newT = { id: Date.now(), date: new Date().toISOString().split('T')[0], location: '', weight: null, isCompleted: false, feedback: '', coachNotes: '', exercises: [{ exerciseId: EXERCISE_LIBRARY[4].id, description: '', series: 3, reps: '1', load: '6a', actual: '' }] };
                
                // Najpierw zapis do bazy, potem aktualizacja lokalna, by uniknƒÖƒá nadpisania przez snapshot
                if (user && window.firestoreOps) {
                    const ref = window.firestoreOps.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings', newT.id.toString());
                    await window.firestoreOps.setDoc(ref, newT);
                }
                
                setTrainings(p => [newT, ...p]);
                setSelectedId(newT.id);
                setIsEditing(true);
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-400 font-medium animate-pulse">≈ÅƒÖczenie...</div>;

            const selected = trainings.find(t => t.id === selectedId);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50 shadow-2xl relative overflow-x-hidden">
                    {selected ? (
                        <TrainingDetailView 
                            training={selected} isEditing={isEditing} 
                            onToggleEdit={() => {
                                if (isEditing) saveToDb(selected); // Dodatkowy zapis przy wy≈ÇƒÖczaniu edycji
                                setIsEditing(!isEditing);
                            }} 
                            onClose={() => { setSelectedId(null); setIsEditing(false); }}
                            onUpdateTraining={handleUpdateT} onUpdateExercise={handleUpdateE}
                            onAddExercise={handleAddE} onDeleteExercise={handleDeleteE} onDeleteTraining={handleDeleteT}
                        />
                    ) : activeTab === 'trainings' ? (
                        <TrainingListView trainings={trainings} onSelect={(id) => { setSelectedId(id); setIsEditing(false); }} onAdd={handleAddT} />
                    ) : (
                        <AnalyticsView trainings={trainings} />
                    )}
                    {!selected && (
                        <div className="fixed bottom-0 max-w-md w-full bg-white/90 backdrop-blur-lg border-t border-slate-200 flex justify-around py-2 z-50">
                            <button onClick={() => setActiveTab('trainings')} className={`flex flex-col items-center p-2 rounded-xl w-32 transition ${activeTab === 'trainings' ? 'text-blue-600 bg-blue-50/50' : 'text-slate-400'}`}><Calendar size={22} /><span className="text-[10px] font-bold mt-1 uppercase">Rozpiska</span></button>
                            <button onClick={() => setActiveTab('analytics')} className={`flex flex-col items-center p-2 rounded-xl w-32 transition ${activeTab === 'analytics' ? 'text-blue-600 bg-blue-50/50' : 'text-slate-400'}`}><TrendingUp size={22} /><span className="text-[10px] font-bold mt-1 uppercase">Postƒôp</span></button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
