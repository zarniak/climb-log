<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClimbLog - Trener Wspinaczki (Online)</title>
    
    <!-- Style: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UNPKG) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #ffffff; color: #1f2937; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .clean-input {
            background: transparent;
            border-bottom: 1px solid #e5e7eb;
            outline: none;
            transition: border-color 0.2s;
            border-radius: 0;
            padding-bottom: 2px;
        }
        .clean-input:focus {
            border-color: #3b82f6;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Error Handler -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            if (message.includes('ResizeObserver')) return;
            const errorContainer = document.createElement('div');
            errorContainer.innerHTML = `
                <div style="position: fixed; top: 20px; left: 20px; right: 20px; z-index: 9999; padding: 20px; font-family: sans-serif; color: #7f1d1d; background: #fef2f2; border: 2px solid #ef4444; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="margin-top:0; font-weight: bold;">⚠️ Błąd aplikacji</h3>
                    <p>Wystąpił problem techniczny.</p>
                    <div style="font-size: 12px; background: rgba(255,255,255,0.7); padding: 10px; border-radius: 4px; overflow: auto; max-height: 100px;">
                        ${message}
                    </div>
                </div>
            `;
            document.body.appendChild(errorContainer);
        };
    </script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            const userConfig = {
              apiKey: "AIzaSyAgIGDQaKWHcBiEUwVavMOpj5TX5n81Bnw",
              authDomain: "climblog-7432b.firebaseapp.com",
              projectId: "climblog-7432b",
              storageBucket: "climblog-7432b.firebasestorage.app",
              messagingSenderId: "155094312417",
              appId: "1:155094312417:web:19e35e3699737be22cdea0"
            }; 

            const firebaseConfig = (userConfig.apiKey !== "TU_WKLEJ_API_KEY") ? userConfig : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'climblog-production';

            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);
                window.appId = appId;
                window.firestoreOps = { collection, doc, setDoc, deleteDoc, onSnapshot, query, getDocs, writeBatch, signInAnonymously, signInWithCustomToken };
                console.log("Firebase initialized.");
            } else {
                console.warn("Brak konfiguracji Firebase. Uzupełnij userConfig.");
            }
        } catch (e) {
            console.error("Firebase init failed:", e);
        }
    </script>

    <script type="text/babel">
        if (!window.React || !window.ReactDOM) throw new Error("Brak Reacta.");
        const { useState, useEffect, useRef, useCallback } = React;

        // --- IKONY SVG ---
        function IconBase({ children, size = 20, className = "" }) {
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
            );
        }

        const Calendar = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const CalendarPlus = (p) => <IconBase {...p}><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M10 16h4"/><path d="M12 14v4"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const MessageSquare = (p) => <IconBase {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2-2h14a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>;
        const Trash = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></IconBase>;
        const ClipboardList = (p) => <IconBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const Pencil = (p) => <IconBase {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></IconBase>;
        const Check = (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Clock = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Play = (p) => <IconBase {...p}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const Pause = (p) => <IconBase {...p}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></IconBase>;
        const SkipBack = (p) => <IconBase {...p}><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" y1="19" x2="5" y2="5"/></IconBase>;
        const SkipForward = (p) => <IconBase {...p}><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" y1="5" x2="19" y2="19"/></IconBase>;

        // --- KOMPONENTY UI ---
        function Card({ children, className = "" }) {
            return (
                <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden ${className}`}>{children}</div>
            );
        }

        function Badge({ children, type = 'neutral' }) {
            const colors = { neutral: 'bg-gray-100 text-gray-600', success: 'bg-green-50 text-green-700 border border-green-100', warning: 'bg-amber-50 text-amber-700 border border-amber-100' };
            return <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wide ${colors[type]}`}>{children}</span>;
        }

        function Header({ title, icon: Icon, action }) {
            return (
                <div className="flex justify-between items-center mb-6 pt-2">
                    <h2 className="text-xl font-bold text-gray-800 flex items-center">
                        <div className="p-2 bg-blue-50 text-blue-600 rounded-lg mr-3">
                            <Icon size={20} />
                        </div>
                        {title}
                    </h2>
                    {action}
                </div>
            );
        }

        // --- TOOLTIP INPUT ---
        function ParamInput({ value, onChange, label, width = "w-10", placeholder = "", wrapperClass = "" }) {
            const [isFocused, setIsFocused] = useState(false);

            return (
                <div className={`relative flex items-center ${wrapperClass}`}>
                    {isFocused && (
                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 z-20 pointer-events-none">
                             <div className="px-2 py-1 bg-slate-800 text-white text-[10px] rounded shadow-md whitespace-nowrap animate-fade-in">
                                {label}
                                <div className="absolute top-full left-1/2 -translate-x-1/2 -mt-[1px] border-4 border-transparent border-t-slate-800"></div>
                            </div>
                        </div>
                    )}
                    <input 
                        value={value || ''}
                        onChange={onChange}
                        onFocus={() => setIsFocused(true)}
                        onBlur={() => setIsFocused(false)}
                        placeholder={placeholder}
                        className={`${width} h-7 text-center bg-gray-50 border border-gray-200 rounded text-xs text-gray-700 outline-none focus:border-blue-400 focus:bg-white transition-colors placeholder-gray-300`}
                    />
                </div>
            );
        }

        // --- HELPERY FORMATOWANIA ---
        const formatEx = (ex) => {
            let repsPart = "";
            if (ex.reps) repsPart += ex.reps;
            
            const t = ex.timeRep;
            const r = ex.restRep;
            if (t && r) repsPart += ` (${t}/${r})`;
            else if (t) repsPart += ` (${t})`;
            else if (r) repsPart += ` (/${r})`;
            
            let seriesPart = "";
            if (ex.series) {
                seriesPart += ex.series;
                if (ex.restSet) seriesPart += ` (${ex.restSet})`;
            }

            let mainPart = "";
            if (repsPart && seriesPart) {
                mainPart = `${repsPart} x ${seriesPart}`;
            } else if (repsPart) {
                mainPart = repsPart;
            } else if (seriesPart) {
                mainPart = seriesPart; 
            }

            let result = mainPart;
            if (ex.load && ex.load !== '-') {
                if (result) {
                    result += ` : ${ex.load}`;
                } else {
                    result = ex.load;
                }
            }
            return result;
        };

        const formatDatePretty = (dateString) => {
            const s = new Date(dateString).toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long' });
            return s.charAt(0).toUpperCase() + s.slice(1);
        };
        
        const formatDateShort = (dateString) => {
            const d = new Date(dateString);
            const day = d.toLocaleDateString('pl-PL', { weekday: 'short' });
            const rest = d.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' });
            return `${day}, ${rest}`;
        };

        const getStatusIconSmall = (status) => {
             if (status === 'done') return <Check size={14} className="text-emerald-500" />;
             if (status === 'attention') return <AlertCircle size={14} className="text-amber-500" />;
             if (status === 'skipped') return <X size={14} className="text-red-500" />;
             return <div className="w-1.5 h-1.5 rounded-full bg-gray-200 ml-1 mr-1"></div>;
        };

        const getStatusIconLarge = (status) => {
             if (status === 'done') return <Check size={18} className="text-emerald-500" />;
             if (status === 'attention') return <AlertCircle size={18} className="text-amber-500" />;
             if (status === 'skipped') return <X size={18} className="text-red-500" />;
             return <div className="w-2.5 h-2.5 rounded-full bg-gray-200"></div>;
        };

        const parseTime = (str) => {
            if (!str) return 0;
            str = str.toString().toLowerCase().trim();
            if (str.includes(':')) {
                const [min, sec] = str.split(':').map(Number);
                return (min * 60) + (sec || 0);
            }
            if (str.includes('m')) return parseFloat(str) * 60;
            return parseFloat(str) || 0;
        };

        // --- AUDIO ENGINE (Web Audio API) ---
        const SoundEngine = {
            ctx: null,
            init: function() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            playTone: function(freq, type, duration, vol = 0.1) {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playTick: function() {
                this.playTone(800, 'sine', 0.1, 0.1);
            },
            playWhistle: function() {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(1500, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(2500, this.ctx.currentTime + 0.1);
                osc.frequency.linearRampToValueAtTime(1500, this.ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.15, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.3);
            },
            playGong: function(deep = false) {
                const freq = deep ? 220 : 440;
                const dur = deep ? 1.5 : 0.8;
                this.playTone(freq, 'sine', dur, 0.15);
            },
            playFanfare: function() {
                const now = this.ctx.currentTime;
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C E G C
                notes.forEach((freq, i) => {
                     const osc = this.ctx.createOscillator();
                     const gain = this.ctx.createGain();
                     osc.type = 'square';
                     osc.frequency.value = freq;
                     gain.gain.setValueAtTime(0.05, now + i*0.15);
                     gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.15 + 0.4);
                     osc.connect(gain);
                     gain.connect(this.ctx.destination);
                     osc.start(now + i*0.15);
                     osc.stop(now + i*0.15 + 0.5);
                });
            }
        };


        // --- TIMER GENERATOR ---
        const generateTimerSteps = (ex) => {
            const steps = [];
            const reps = parseInt(ex.reps) || 1;
            const series = parseInt(ex.series) || 1;
            const timeRep = parseTime(ex.timeRep);
            const restRep = parseTime(ex.restRep);
            const restSet = parseTime(ex.restSet);

            steps.push({ type: 'prep', duration: 10, label: 'Przygotuj się!', color: 'bg-emerald-500', text: 'text-emerald-100', ring: 'ring-emerald-300' });

            for (let s = 1; s <= series; s++) {
                for (let r = 1; r <= reps; r++) {
                    if (timeRep > 0) {
                        steps.push({ type: 'work', duration: timeRep, label: `Praca (S:${s}/${series} P:${r}/${reps})`, color: 'bg-red-600', text: 'text-red-100', ring: 'ring-red-400', seriesIdx: s, repsIdx: r });
                    }
                    if (r < reps && restRep > 0) {
                        steps.push({ type: 'rest_rep', duration: restRep, label: `Przerwa (S:${s}/${series})`, color: 'bg-blue-500', text: 'text-blue-100', ring: 'ring-blue-300', seriesIdx: s, repsIdx: r });
                    }
                }
                if (s < series && restSet > 0) {
                    steps.push({ type: 'rest_set', duration: restSet, label: 'Przerwa między seriami', color: 'bg-amber-500', text: 'text-amber-100', ring: 'ring-amber-300', seriesIdx: s });
                }
            }

            steps.push({ type: 'done', duration: 0, label: 'Koniec!', color: 'bg-slate-800', text: 'text-gray-300', ring: 'ring-gray-600' });
            return steps;
        };

        // --- DANE DOMYŚLNE ---
        const INITIAL_EXERCISE_LIBRARY = [
            { id: 'ex_pull_australian', name: 'Podciąganie Australijskie', category: 'Siła', defaultSeries: 3, defaultReps: '5', defaultLoad: 'masy ciała', defaultTimeRep: '', defaultRestRep: '', defaultRestSet: '2m', defaultDescription: 'Dynamiczny ruch w górę, powolne opuszczanie.' },
            { id: 'ex_plank', name: 'Plank Klasyczny', category: 'Core', defaultSeries: 5, defaultReps: '40s', defaultLoad: '', defaultTimeRep: '', defaultRestRep: '20s', defaultRestSet: '', defaultDescription: 'Trzymaj napięty brzuch, nie opuszczaj bioder.' },
            { id: 'ex_hangboard_90', name: 'Zwis 90 stopni', category: 'Siła Palców', defaultSeries: 3, defaultReps: '10s', defaultLoad: 'masy ciała', defaultTimeRep: '', defaultRestRep: '', defaultRestSet: '3m', defaultDescription: 'Łokcie lekko zgięte, chwyt otwarty.' },
            { id: 'ex_climb_endurance', name: 'Obwody / Wytrzymałość', category: 'Wspinanie', defaultSeries: 1, defaultReps: '1', defaultLoad: '6a', defaultTimeRep: '', defaultRestRep: '', defaultRestSet: '', defaultDescription: 'Wspinanie ciągłe, staraj się odpoczywać na chwytach.' },
        ];

        const generateCalendarLink = (training) => {
            const text = encodeURIComponent(`Trening Wspinaczkowy @ ${training.location}`);
            const details = encodeURIComponent(`Plan: ${training.coachNotes}`);
            const dates = `${training.date.replace(/-/g, '')}T180000/${training.date.replace(/-/g, '')}T200000`;
            return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&details=${details}&dates=${dates}`;
        };

        // --- WIDOKI ---

        function TimerView({ timerData, onBack }) {
            const [steps, setSteps] = useState([]);
            const [currentStepIndex, setCurrentStepIndex] = useState(0);
            const [timeLeft, setTimeLeft] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            
            useEffect(() => {
                if (timerData) {
                    const generatedSteps = generateTimerSteps(timerData);
                    setSteps(generatedSteps);
                    if (generatedSteps.length > 0) {
                        setTimeLeft(generatedSteps[0].duration);
                        setIsRunning(true);
                        SoundEngine.init();
                    }
                }
            }, [timerData]);

            const playStepSound = (type) => {
                if(type === 'work') SoundEngine.playWhistle();
                else if(type === 'rest_rep') SoundEngine.playGong(false);
                else if(type === 'rest_set') SoundEngine.playGong(true);
                else if(type === 'done') SoundEngine.playFanfare();
            };

            useEffect(() => {
                let interval = null;
                if (isRunning && currentStepIndex < steps.length) {
                    interval = setInterval(() => {
                        setTimeLeft((prev) => {
                            if (prev <= 4 && prev > 1) {
                                SoundEngine.playTick();
                            }
                            if (prev <= 1) {
                                const nextIndex = currentStepIndex + 1;
                                if (nextIndex < steps.length) {
                                    setCurrentStepIndex(nextIndex);
                                    const nextStep = steps[nextIndex];
                                    playStepSound(nextStep.type);
                                    return nextStep.duration;
                                } else {
                                    playStepSound('done');
                                    setIsRunning(false);
                                    return 0;
                                }
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isRunning, currentStepIndex, steps]);

            const currentStep = steps[currentStepIndex] || { color: 'bg-gray-800', label: 'Ładowanie...', duration: 0, text: 'text-white' };
            const isFinished = currentStep.type === 'done';

            const handleReset = () => {
                setIsRunning(false);
                setCurrentStepIndex(0);
                if (steps.length > 0) setTimeLeft(steps[0].duration);
            };

            const handleNext = () => {
                const nextIndex = currentStepIndex + 1;
                if (nextIndex < steps.length) {
                    setCurrentStepIndex(nextIndex);
                    setTimeLeft(steps[nextIndex].duration);
                } else {
                     setCurrentStepIndex(steps.length - 1);
                     setTimeLeft(0);
                     setIsRunning(false);
                }
            };

            const handlePrev = () => {
                const prevIndex = currentStepIndex - 1;
                if (prevIndex >= 0) {
                    setCurrentStepIndex(prevIndex);
                    setTimeLeft(steps[prevIndex].duration);
                } else {
                    setTimeLeft(steps[0].duration);
                }
            };

            const togglePlay = () => {
                if (!isRunning) SoundEngine.init();
                setIsRunning(!isRunning);
            }

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m > 0 ? m + ':' : ''}${s < 10 && m > 0 ? '0' : ''}${s}`;
            };

            return (
                <div className={`min-h-screen transition-colors duration-500 flex flex-col ${currentStep.color}`}>
                     <div className="absolute top-4 left-4 z-10">
                        <button onClick={onBack} className="bg-white/20 hover:bg-white/30 text-white rounded-full p-2 backdrop-blur-sm transition">
                            <ChevronRight className="rotate-180" size={24} />
                        </button>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center p-6 text-center">
                        <h2 className={`text-2xl font-bold uppercase tracking-widest mb-2 opacity-80 ${currentStep.text}`}>{timerData?.name || 'Timer'}</h2>
                        <div className={`text-xl font-medium mb-8 opacity-90 ${currentStep.text}`}>{currentStep.label}</div>
                        
                        <div className="text-[120px] font-black text-white leading-none tabular-nums tracking-tighter drop-shadow-lg mb-8">
                            {isFinished ? <Check size={100}/> : formatTime(timeLeft)}
                        </div>

                        {!isFinished && (
                            <div className="flex gap-4 mb-8 items-center">
                                <button onClick={handlePrev} className="bg-white/20 text-white w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-md hover:bg-white/30 transition active:scale-95">
                                    <SkipBack size={20} />
                                </button>
                                <button onClick={togglePlay} className="bg-white text-gray-800 w-20 h-20 rounded-full flex items-center justify-center shadow-lg active:scale-95 transition">
                                    {isRunning ? <Pause size={36} /> : <Play size={36} className="ml-1" />}
                                </button>
                                <button onClick={handleReset} className="bg-white/20 text-white w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-md hover:bg-white/30 transition active:scale-95">
                                    <RotateCcw size={20} />
                                </button>
                                <button onClick={handleNext} className="bg-white/20 text-white w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-md hover:bg-white/30 transition active:scale-95">
                                    <SkipForward size={20} />
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="bg-white/95 backdrop-blur-md rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] h-1/3 overflow-hidden flex flex-col">
                        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-white">
                            <span className="text-xs font-bold uppercase text-gray-400 tracking-wider">Plan treningu</span>
                            <span className="text-xs font-mono text-gray-500">{steps.length - 1 - currentStepIndex} kroków do końca</span>
                        </div>
                        <div className="overflow-y-auto p-2 space-y-2 flex-1 no-scrollbar">
                            {steps.map((step, idx) => {
                                if (idx < currentStepIndex) return null;
                                const isCurrent = idx === currentStepIndex;
                                return (
                                    <div key={idx} className={`flex items-center p-3 rounded-xl transition-all ${isCurrent ? `bg-gray-100 border-l-4 ${currentStep.color.replace('bg-', 'border-')} shadow-sm` : 'opacity-50 grayscale'}`}>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white mr-3 shrink-0 ${step.color}`}>
                                            {step.duration}s
                                        </div>
                                        <div className="text-left">
                                            <div className="text-sm font-bold text-gray-800">{step.label}</div>
                                            {step.type !== 'done' && <div className="text-[10px] text-gray-500 uppercase">{step.type === 'prep' ? 'Start' : step.type === 'work' ? 'Ćwiczenie' : 'Odpoczynek'}</div>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        function TrainingListView({ trainings, onSelect, onAdd, exerciseLibrary }) {
            const [viewMode, setViewMode] = useState('planned');
            const filtered = trainings.filter(t => !!t.isCompleted === (viewMode === 'completed'));
            const sorted = [...filtered].sort((a, b) => viewMode === 'planned' ? new Date(a.date) - new Date(b.date) : new Date(b.date) - new Date(a.date));

            return (
                <div className="p-4 pt-6 pb-24 animate-fade-in max-w-md mx-auto">
                    <Header 
                        title="Twoja Rozpiska" 
                        icon={Calendar} 
                        action={<button onClick={onAdd} className="bg-blue-600 text-white w-10 h-10 rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 transition active:scale-95 flex items-center justify-center"><Plus size={24} /></button>}
                    />
                    
                    <div className="bg-gray-100 p-1 rounded-xl flex mb-6">
                        <button onClick={() => setViewMode('planned')} className={`flex-1 py-1.5 text-xs font-bold uppercase tracking-wide rounded-lg transition ${viewMode === 'planned' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>Zaplanowane</button>
                        <button onClick={() => setViewMode('completed')} className={`flex-1 py-1.5 text-xs font-bold uppercase tracking-wide rounded-lg transition ${viewMode === 'completed' ? 'bg-white text-emerald-600 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>Zakończone</button>
                    </div>

                    {sorted.length === 0 ? (
                        <div className="text-center py-16 text-gray-300">
                            <ClipboardList className="mx-auto mb-3 opacity-20" size={48} />
                            <p className="text-sm font-medium">{viewMode === 'planned' ? 'Brak zaplanowanych treningów' : 'Brak historii'}</p>
                        </div>
                    ) : (
                        sorted.map((t) => (
                            <Card key={t.id} className="mb-3 hover:border-blue-100 transition duration-200 group">
                                <div className="p-4 cursor-pointer" onClick={() => onSelect(t.id)}>
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <div className="text-sm font-bold text-gray-800">
                                                {formatDatePretty(t.date)}
                                            </div>
                                            <div className="flex items-center text-gray-400 mt-0.5">
                                                <MapPin size={14} className="mr-1 text-blue-500" />
                                                <span className="text-xs">{t.location || 'Brak lokalizacji'}</span>
                                            </div>
                                        </div>
                                        {t.isCompleted ? <Badge type="success">Ukończony</Badge> : <Badge type="warning">Zaplanowany</Badge>}
                                    </div>
                                    <div className="mt-3 pl-1 group-hover:border-blue-100 transition">
                                        {t.exercises && t.exercises.map((ex, idx) => {
                                            const libEx = exerciseLibrary.find(e => e.id === ex.exerciseId);
                                            return (
                                                <div key={idx} className="flex justify-between items-center mb-1.5">
                                                    <div className="flex items-center gap-2 overflow-hidden">
                                                        <div className="shrink-0 flex items-center justify-center w-4">
                                                            {getStatusIconSmall(ex.status)}
                                                        </div>
                                                        <div className="text-xs text-gray-700 truncate">{libEx?.name || 'Ćwiczenie'}</div>
                                                    </div>
                                                    <span className="text-xs text-gray-600 text-right ml-2 shrink-0">{formatEx(ex)}</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </Card>
                        ))
                    )}
                </div>
            );
        }

        // --- GŁÓWNA APLIKACJA ---

        function App() {
            const [activeTab, setActiveTab] = useState('trainings');
            const [trainings, setTrainings] = useState([]);
            const [exerciseLibrary, setExerciseLibrary] = useState(INITIAL_EXERCISE_LIBRARY);
            const [selectedId, setSelectedId] = useState(null);
            const [user, setUser] = useState(null);
            const [isOnline, setIsOnline] = useState(false);
            const [timerData, setTimerData] = useState(null);
            const saveTimeout = useRef(null);

            // --- FIREBASE SYNC ---
            useEffect(() => {
                let unsubAuth = null;
                let unsubTrainings = null;
                let unsubSettings = null;

                const initSync = async () => {
                    let attempts = 0;
                    while (!window.firestoreOps && attempts < 20) { await new Promise(r => setTimeout(r, 100)); attempts++; }
                    if (!window.firestoreOps) return;

                    const { signInAnonymously, signInWithCustomToken, collection, doc, onSnapshot, query } = window.firestoreOps;
                    
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(window.auth, __initial_auth_token);
                        else await signInAnonymously(window.auth);
                    } catch (e) { console.error("Auth failed", e); return; }

                    unsubAuth = window.auth.onAuthStateChanged(async (u) => {
                        setUser(u);
                        setIsOnline(!!u);
                        if (u) {
                            const trainingsRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings');
                            unsubTrainings = onSnapshot(query(trainingsRef), (snap) => {
                                const data = snap.docs.map(d => d.data());
                                setTrainings(data.sort((a, b) => new Date(b.date) - new Date(a.date)));
                            });

                            const settingsRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'exercises');
                            unsubSettings = onSnapshot(settingsRef, (snap) => {
                                if (snap.exists()) {
                                    setExerciseLibrary(snap.data().list || INITIAL_EXERCISE_LIBRARY);
                                }
                            });
                        }
                    });
                };
                initSync();
                return () => { 
                    if (unsubAuth) unsubAuth(); 
                    if (unsubTrainings) unsubTrainings();
                    if (unsubSettings) unsubSettings();
                };
            }, []);

            // --- ZAPIS ---
            const saveTrainingToDb = useCallback((training) => {
                if (!user || !window.firestoreOps) return;
                if (saveTimeout.current) clearTimeout(saveTimeout.current);
                saveTimeout.current = setTimeout(async () => {
                    try {
                        const ref = window.firestoreOps.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings', training.id.toString());
                        await window.firestoreOps.setDoc(ref, training);
                    } catch (e) { console.error("Save error:", e); }
                }, 500);
            }, [user]);

            const saveLibraryToDb = useCallback((newLib) => {
                if (!user || !window.firestoreOps) return;
                try {
                    const ref = window.firestoreOps.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'exercises');
                    window.firestoreOps.setDoc(ref, { list: newLib });
                } catch (e) { console.error("Save lib error:", e); }
            }, [user]);

            // --- LOGIKA ---
            const handleUpdateT = (id, field, value) => {
                setTrainings(prev => {
                    const next = prev.map(t => t.id === id ? { ...t, [field]: value } : t);
                    const updated = next.find(t => t.id === id);
                    if (updated) saveTrainingToDb(updated);
                    return next;
                });
            };

            const handleUpdateE = (id, idx, field, value) => {
                setTrainings(prev => {
                    const next = prev.map(t => {
                        if (t.id !== id) return t;
                        const newEx = [...t.exercises];
                        if (field === 'exerciseId') {
                             const libEx = exerciseLibrary.find(e => e.id === value);
                             if (libEx) {
                                 newEx[idx] = { ...newEx[idx], exerciseId: value, description: libEx.defaultDescription, series: libEx.defaultSeries, reps: libEx.defaultReps, load: libEx.defaultLoad, timeRep: libEx.defaultTimeRep, restRep: libEx.defaultRestRep, restSet: libEx.defaultRestSet };
                             }
                        } else {
                            newEx[idx] = { ...newEx[idx], [field]: value };
                        }
                        return { ...t, exercises: newEx };
                    });
                    const updated = next.find(t => t.id === id);
                    if (updated) saveTrainingToDb(updated);
                    return next;
                });
            };

            const handleAddE = (id) => {
                setTrainings(prev => {
                    const next = prev.map(t => {
                        if (t.id !== id) return t;
                        const defaultEx = exerciseLibrary[0] || {};
                        return { ...t, exercises: [...(t.exercises||[]), { exerciseId: defaultEx.id || 'unknown', description: defaultEx.defaultDescription || '', series: defaultEx.defaultSeries || 3, reps: defaultEx.defaultReps || '10', load: defaultEx.defaultLoad || '-', timeRep: defaultEx.defaultTimeRep || '', restRep: defaultEx.defaultRestRep || '', restSet: defaultEx.defaultRestSet || '', actual: '', status: null }] };
                    });
                    const updated = next.find(t => t.id === id);
                    if (updated) saveTrainingToDb(updated);
                    return next;
                });
            };

            const handleDeleteE = (id, idx) => {
                if(!confirm("Usuń ćwiczenie?")) return;
                setTrainings(prev => {
                    const next = prev.map(t => {
                        if (t.id !== id) return t;
                        return { ...t, exercises: t.exercises.filter((_, i) => i !== idx) };
                    });
                    const updated = next.find(t => t.id === id);
                    if (updated) saveTrainingToDb(updated);
                    return next;
                });
            };

            const handleDeleteT = async (id) => {
                if (!confirm("Usuń cały trening?")) return;
                if (user && window.firestoreOps) {
                    try {
                        await window.firestoreOps.deleteDoc(window.firestoreOps.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings', id.toString()));
                        setSelectedId(null);
                    } catch (e) { console.error(e); }
                }
            };

            const handleAddT = async () => {
                const newId = Date.now();
                const defaultEx = exerciseLibrary[0] || {};
                const newT = { id: newId, date: new Date().toISOString().split('T')[0], location: '', isCompleted: false, feedback: '', coachNotes: '', exercises: [{ exerciseId: defaultEx.id || 'unknown', description: defaultEx.defaultDescription || '', series: defaultEx.defaultSeries || 3, reps: defaultEx.defaultReps || '10', load: defaultEx.defaultLoad || '-', timeRep: defaultEx.defaultTimeRep || '', restRep: defaultEx.defaultRestRep || '', restSet: defaultEx.defaultRestSet || '', actual: '', status: null }] };
                if (user && window.firestoreOps) {
                    const ref = window.firestoreOps.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'trainings', newId.toString());
                    await window.firestoreOps.setDoc(ref, newT);
                }
                setTrainings(p => [newT, ...p]);
                setSelectedId(newId);
            };

            const handleUpdateLib = (id, field, value) => {
                const newLib = exerciseLibrary.map(ex => ex.id === id ? { ...ex, [field]: value } : ex);
                setExerciseLibrary(newLib);
                saveLibraryToDb(newLib);
            };

            const handleAddLib = () => {
                const newEx = { id: `ex_${Date.now()}`, name: 'Nowe Ćwiczenie', category: 'Ogólne', defaultSeries: 3, defaultReps: '10', defaultLoad: '-', defaultRestSet: '', defaultTimeRep: '', defaultRestRep: '', defaultDescription: '' };
                const newLib = [newEx, ...exerciseLibrary];
                setExerciseLibrary(newLib);
                saveLibraryToDb(newLib);
            };

            const handleDeleteLib = (id) => {
                if(!confirm("Czy na pewno chcesz usunąć to ćwiczenie z bazy?")) return;
                const newLib = exerciseLibrary.filter(ex => ex.id !== id);
                setExerciseLibrary(newLib);
                saveLibraryToDb(newLib);
            };

            const handleStartTimer = (ex) => {
                setTimerData(ex);
                setActiveTab('timer');
            };

            const selected = trainings.find(t => t.id === selectedId);

            return (
                <div className="max-w-md mx-auto min-h-screen relative overflow-x-hidden">
                    {/* Status Bar (Thin Line) */}
                    <div className={`fixed top-0 left-0 w-full h-1 z-[100] transition-colors duration-500 ${isOnline ? 'bg-emerald-400' : 'bg-red-400'}`}></div>

                    {activeTab === 'timer' ? (
                        <TimerView timerData={timerData} onBack={() => setActiveTab('trainings')} />
                    ) : selected ? (
                        <TrainingDetailView 
                            training={selected} 
                            onClose={() => { setSelectedId(null); }}
                            onUpdateTraining={handleUpdateT} onUpdateExercise={handleUpdateE}
                            onAddExercise={handleAddE} onDeleteExercise={handleDeleteE} onDeleteTraining={handleDeleteT}
                            exerciseLibrary={exerciseLibrary}
                            onStartTimer={handleStartTimer}
                        />
                    ) : activeTab === 'trainings' ? (
                        <TrainingListView 
                            trainings={trainings} 
                            onSelect={(id) => { setSelectedId(id); }} 
                            onAdd={handleAddT} 
                            exerciseLibrary={exerciseLibrary} 
                        />
                    ) : activeTab === 'analytics' ? (
                        <AnalyticsView trainings={trainings} exerciseLibrary={exerciseLibrary} />
                    ) : (
                        <ExercisesView 
                            library={exerciseLibrary} 
                            onUpdate={handleUpdateLib} 
                            onAdd={handleAddLib} 
                            onDelete={handleDeleteLib} 
                        />
                    )}
                    
                    {!selected && activeTab !== 'timer' && (
                        <div className="fixed bottom-0 max-w-md w-full bg-white/95 backdrop-blur-md border-t border-gray-100 flex justify-around py-3 z-50 shadow-[0_-5px_20px_rgba(0,0,0,0.02)]">
                            <button onClick={() => setActiveTab('trainings')} className={`flex flex-col items-center p-2 rounded-xl w-24 transition ${activeTab === 'trainings' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}><Calendar size={20} className="mb-1" /><span className="text-[9px] font-bold uppercase tracking-wider">Rozpiska</span></button>
                            <button onClick={() => setActiveTab('analytics')} className={`flex flex-col items-center p-2 rounded-xl w-24 transition ${activeTab === 'analytics' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}><TrendingUp size={20} className="mb-1" /><span className="text-[9px] font-bold uppercase tracking-wider">Postęp</span></button>
                            <button onClick={() => setActiveTab('exercises')} className={`flex flex-col items-center p-2 rounded-xl w-24 transition ${activeTab === 'exercises' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}><ClipboardList size={20} className="mb-1" /><span className="text-[9px] font-bold uppercase tracking-wider">Zadania</span></button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
